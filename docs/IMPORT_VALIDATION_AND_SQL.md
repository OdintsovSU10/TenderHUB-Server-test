# Валидация импорта и генерация SQL для новых единиц измерения

## Обновленный функционал импорта

### 1. Проверка единиц измерения

При импорте Excel файла система автоматически проверяет все единицы измерения на соответствие существующим в базе данных.

**Разрешенные единицы измерения:**
- `шт` - штуки
- `м` - метры
- `м2` - квадратные метры
- `м3` - кубические метры
- `кг` - килограммы
- `т` - тонны
- `л` - литры
- `компл` - комплект
- `м.п.` - метры погонные

### 2. Автоматическая генерация SQL

Если в импортируемом файле обнаружены новые единицы измерения, которых нет в системе, автоматически генерируется SQL запрос для их добавления в базу данных.

**Пример сгенерированного SQL:**
```sql
-- SQL для добавления новых единиц измерения в тип unit_type
ALTER TYPE public.unit_type ADD VALUE IF NOT EXISTS 'точка';
ALTER TYPE public.unit_type ADD VALUE IF NOT EXISTS 'км';
ALTER TYPE public.unit_type ADD VALUE IF NOT EXISTS 'прибор';

-- Альтернативный способ (пересоздание типа):
BEGIN;
ALTER TYPE public.unit_type RENAME TO unit_type_old;

CREATE TYPE public.unit_type AS ENUM (
  'шт', 'м', 'м2', 'м3', 'кг', 'т', 'л', 'компл', 'м.п.',
  'точка', 'км', 'прибор'
);

-- Обновление всех таблиц...
COMMIT;
```

### 3. Детальный вывод ошибок

Система предоставляет подробную информацию об ошибках импорта:

- **Ошибки валидации данных**:
  - Неполные строки (менее 6 столбцов)
  - Пустые обязательные поля
  - Номера строк с ошибками

- **Ошибки сохранения в БД**:
  - Ошибки создания категорий
  - Ошибки добавления деталей
  - Конкретные сообщения от базы данных

## Процесс работы с новыми единицами измерения

### Шаг 1: Попытка импорта
1. Нажмите "Импорт из Excel"
2. Выберите файл с данными

### Шаг 2: Обработка ошибок
Если обнаружены новые единицы измерения:
1. Появится модальное окно с SQL запросом
2. Нажмите "Скопировать SQL"
3. Импорт будет остановлен

### Шаг 3: Добавление новых единиц в БД
1. Откройте Supabase SQL Editor
2. Вставьте скопированный SQL
3. Выполните запрос
4. Дождитесь подтверждения успешного выполнения

### Шаг 4: Повторный импорт
1. Вернитесь в приложение
2. Повторите импорт того же файла
3. Теперь импорт пройдет успешно

## Тестовые файлы

Для тестирования функционала доступны файлы:

1. **`/public/template_cost_import.xlsx`** - шаблон с корректными единицами измерения
2. **`/public/test_new_units.xlsx`** - тестовый файл с новыми единицами измерения для демонстрации SQL генерации

## Обработка ошибок

### Модальное окно с SQL
- Показывает полный SQL запрос для выполнения
- Кнопка "Скопировать SQL" для удобного копирования
- Предоставляет два варианта SQL (быстрый и полный)

### Модальное окно с ошибками
- Отображает все ошибки валидации
- Указывает конкретные номера строк
- Показывает ошибки сохранения в БД

## Важные моменты

1. **Транзакционность**: Импорт прерывается при обнаружении неизвестных единиц измерения
2. **Целостность данных**: Категории не дублируются при повторном импорте
3. **Информативность**: Пользователь всегда знает, что пошло не так и как это исправить

## Рекомендации

- Перед импортом больших файлов проверьте единицы измерения
- Сохраняйте сгенерированные SQL запросы для будущего использования
- При массовом импорте сначала протестируйте на небольшом файле