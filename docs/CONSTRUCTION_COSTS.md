# Документация страниц Затрат на строительство

## Обзор

TenderHUB имеет **ДВЕ отдельные страницы** для затрат на строительство с разными целями:

1. **Справочник затрат** (`/admin/construction_cost`) - Управление структурой
2. **Анализ затрат на строительство** (`/costs`) - Анализ по конкретному тендеру

Этот документ охватывает **ОБЕ** страницы и объясняет их различия.

---

# Часть 1: Справочник затрат

## Обзор

**Маршрут**: `/admin/construction_cost`
**Компонент**: `src/pages/Admin/ConstructionCost/ConstructionCost.tsx`
**Назначение**: Управление организационной структурой и каталогом категорий затрат
**Уровень доступа**: Пользователи-администраторы

## Назначение и варианты использования

### Основное назначение
Управление **структурой каталога** категорий затрат без данных по конкретным тендерам:
- Настройка начальной структуры затрат
- Добавление новых типов работ/материалов
- Импорт структуры затрат из Excel
- Управление каталогом затрат для организации

### НЕ используется для
- Просмотра затрат по конкретным тендерам
- Редактирования объемов работ по проектам
- Расчета затрат тендера
- Анализа коммерческих и прямых затрат

## Функции

### 1. Трехуровневая иерархия
**Структура**:
```
Категория затрат (Уровень 1)
└── Детализация категории (Уровень 2)
    └── Локация (Уровень 3)
```

**Пример**:
```
Общестроительные работы
└── Кирпичная кладка
    ├── Наружные стены
    └── Внутренние перегородки
```

### 2. CRUD операции
- **Добавить категорию**: Создать категорию затрат верхнего уровня
- **Добавить детализацию**: Добавить детализацию под категорию
- **Добавить локацию**: Добавить локацию под детализацию
- **Редактировать**: Изменить название, единицу измерения, локацию
- **Удалить**: Удалить элемент (с предупреждением о каскаде)
- **Удалить все**: Массовое удаление всей структуры

### 3. Импорт из Excel
- **Импорт структуры**: Чтение трехуровневой иерархии из Excel
- **Автоматическое определение**: Автоматический поиск новых единиц измерения
- **Генерация SQL**: Создание INSERT запросов
- **Ручное выполнение**: Пользователь копирует SQL в Supabase
- **Валидация**: Проверка структуры и типов данных

### 4. Раскрытие/Сворачивание
- **Раскрыть все**: Открыть все узлы дерева
- **Свернуть все**: Закрыть все узлы дерева
- **Индивидуальное переключение**: Клик для раскрытия/сворачивания

### 5. Управление единицами измерения
- **Цветовое кодирование единиц**: Визуальная идентификация единиц
- **Автоматическое добавление новых единиц**: Обнаружение при импорте
- **Выбор единицы**: Выпадающий список для редактирования

## UI компоненты

### CostTable
**Назначение**: Иерархическая таблица-дерево

**Колонки**:
1. Структура (раскрывающееся дерево)
2. Единица измерения (цветная метка)
3. Локация
4. Действия (Редактировать, Удалить, кнопки Добавить)

**Типы строк**:
- Строки категорий (Уровень 1, жирный)
- Строки детализации (Уровень 2, с отступом)
- Строки локаций (Уровень 3, с двойным отступом)

**Действия по уровням**:
- Категория: Редактировать, Удалить, Добавить детализацию
- Детализация: Редактировать, Удалить, Добавить локацию
- Локация: Редактировать, Удалить

### Компонент ImportExcel
**Назначение**: Импорт структуры затрат из файла Excel

**Процесс**:
1. Выбрать файл Excel
2. Разобрать структуру и валидировать
3. Проверить наличие новых единиц измерения
4. Сгенерировать SQL INSERT запросы
5. Показать SQL в модальном окне
6. Пользователь копирует в SQL редактор Supabase
7. Пользователь выполняет вручную
8. Обновить для просмотра импортированных данных

**Валидация**:
- Проверка обязательных колонок
- Валидация структуры иерархии
- Обеспечение форматов единиц измерения
- Обнаружение дубликатов

### Компонент CostModals
**Назначение**: Модальные окна редактирования и добавления

**Модальные окна**:
1. **Модальное окно редактирования**: Изменить название, единицу, локацию
2. **Модальное окно добавления категории**: Создать новую категорию затрат
3. **Модальное окно добавления детализации**: Создать новую детализацию
4. **Модальное окно добавления локации**: Создать новую локацию

## Модель данных

### Таблица: `cost_categories`
```sql
CREATE TABLE cost_categories (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL UNIQUE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### Таблица: `detail_cost_categories`
```sql
CREATE TABLE detail_cost_categories (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  cost_category_id UUID REFERENCES cost_categories(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  unit TEXT,
  location TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**Примечание**: Локация хранится как TEXT в таблице детализации, не в отдельной таблице.

## Пользовательские сценарии

### Импорт структуры затрат
1. Нажать "Импорт из Excel"
2. Выбрать файл Excel со структурой
3. Файл разобран, структура валидирована
4. Обнаружены новые единицы измерения (если есть)
5. Открывается модальное окно SQL с INSERT запросами
6. Скопировать SQL в буфер обмена
7. Открыть SQL редактор Supabase
8. Вставить и выполнить SQL
9. Вернуться на страницу и обновить
10. Увидеть импортированную структуру

### Добавление категории затрат
1. Нажать "Добавить категорию"
2. Открывается модальное окно
3. Ввести название категории
4. Нажать "Создать"
5. Категория добавлена в дерево

### Добавление детализации
1. Найти родительскую категорию в дереве
2. Нажать "+ Детализация" в строке категории
3. Открывается модальное окно с названием родителя
4. Ввести название детализации и единицу измерения
5. Нажать "Создать"
6. Детализация добавлена под категорию

### Добавление локации
1. Найти родительскую детализацию в дереве
2. Нажать "+ Локация" в строке детализации
3. Открывается модальное окно с информацией о родителе
4. Ввести название локации
5. Нажать "Создать"
6. Локация добавлена под детализацию

### Редактирование элемента
1. Нажать иконку "Редактировать" в любой строке
2. Открывается модальное окно с текущими значениями
3. Изменить название, единицу или локацию
4. Нажать "Сохранить"
5. Элемент обновлен в дереве

### Удаление всех затрат
1. Нажать кнопку "Удалить затраты"
2. Появляется диалог подтверждения
3. Нажать "Удалить" для подтверждения
4. Все категории и детализации удалены
5. Дерево становится пустым

---

# Часть 2: Анализ затрат на строительство

## Обзор

**Маршрут**: `/costs`
**Компонент**: `src/pages/Admin/ConstructionCostNew/ConstructionCostNew.tsx`
**Назначение**: Анализ затрат по конкретным тендерам с управлением объемами
**Уровень доступа**: Все аутентифицированные пользователи

## Назначение и варианты использования

### Основное назначение
Анализ **затрат по конкретному тендеру** с расчетами:
- Просмотр затрат по выбранному тендеру
- Редактирование объемов работ
- Сравнение прямых и коммерческих затрат
- Экспорт отчетов по затратам в Excel
- Анализ распределения затрат

### НЕ используется для
- Настройки структуры затрат
- Управления каталогом затрат
- Импорта категорий затрат
- Общих CRUD операций с категориями затрат

## Функции

### 1. Выбор тендера
- **Двухэтапный выбор**:
  - Выбрать название тендера
  - Выбрать версию
- **Быстрый выбор карточек**: Сетка последних тендеров
- **Обратная навигация**: Возврат к выбору

### 2. Переключение типа затрат
- **Прямые затраты**: Базовые затраты без наценки
- **Коммерческие затраты**: Затраты с применением наценки
- **Переключатель**: Мгновенное переключение режима

### 3. Управление объемами
- **Редактируемые объемы**: Клик для редактирования объемов работ
- **Хранение в БД**: Объемы сохраняются в `construction_cost_volumes`
- **Автосохранение**: При потере фокуса или нажатии Enter
- **Обновление расчетов**: Цены пересчитываются при изменении объема

### 4. Расчет затрат
**Автоматический расчет из позиций СМР**:
- Агрегация позиций СМР по категориям затрат
- Группировка по типам позиций (мат, раб, суб-мат и т.д.)
- Применение ценообразования на основе типа затрат (прямые/коммерческие)
- Умножение на объемы

### 5. Разбивка по типам
**Шесть типов позиций**:
1. Материалы (мат)
2. Работы (раб)
3. Субподрядные материалы (суб-мат)
4. Субподрядные работы (суб-раб)
5. Компонентные материалы (мат-комп.)
6. Компонентные работы (раб-комп.)

**Каждый показывает**:
- Объем
- Единичная стоимость
- Общая стоимость

### 6. Режимы просмотра
- **Детальный вид**: Все категории, детализации, локации
- **Сводный вид**: Агрегированные по категориям

### 7. Фильтры
- **Поиск**: Фильтрация по названию
- **Скрыть нулевые**: Показать только ненулевые затраты
- **Показать только используемые**: Категории, используемые в тендере
- **Раскрыть/Свернуть**: Навигация по дереву

### 8. Экспорт в Excel
**Экспорт на двух листах**:
- Лист 1: Прямые затраты
- Лист 2: Коммерческие затраты

**Формат**:
- Сохранена трехуровневая иерархия
- Колонки разбивки по типам
- Форматированные числа и границы
- Итоги и промежуточные итоги

## UI компоненты

### TenderSelection
**Назначение**: Начальный выбор тендера

**Функции**:
- Выпадающие списки тендеров
- Селектор версии
- Карточки быстрого выбора
- Отображение имени заказчика

### CostFilters
**Назначение**: Управление типом затрат и видом

**Элементы управления**:
- Переключатель Прямые/Коммерческие
- Переключатель вида Детально/Сводка
- Поле поиска
- Кнопки Раскрыть/Свернуть
- Кнопка Обновить
- Кнопка Экспорт

### CostTable
**Назначение**: Иерархическая таблица затрат

**Колонки (Детальный вид)**:
1. Категория/Детализация/Локация
2-7. Колонки типов (Материалы, Работы, Суб-Материалы, Суб-Работы, Комп-Материалы, Комп-Работы)
8. Итого
9. Объем (редактируемый)
10. Ед. стоимость
11. Общая стоимость

**Колонки (Сводный вид)**:
1. Категория
2. Итого материалы
3. Итого работы
4. Общий итог

**Функции строк**:
- Раскрывающаяся иерархия
- Редактируемые ячейки объема
- Жирные итоги
- Цветовое кодирование по уровням

## Модель данных

### Таблица: `construction_cost_volumes`
```sql
CREATE TABLE construction_cost_volumes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  tender_id UUID REFERENCES tenders(id) ON DELETE CASCADE,
  detail_cost_category_id UUID REFERENCES detail_cost_categories(id) ON DELETE CASCADE,
  volume NUMERIC(15,3),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  UNIQUE(tender_id, detail_cost_category_id)
);
```

**Назначение**: Хранение объемов работ по тендеру

### Запрос расчета
```sql
-- Агрегация позиций СМР по категории затрат и типу
SELECT
  dcc.id as detail_cost_category_id,
  dcc.name,
  cc.name as category_name,
  dcc.location,

  -- Материалы
  SUM(CASE
    WHEN bi.boq_item_type = 'мат'
    THEN bi.initial_price * bi.quantity  -- ИЛИ calculated_price для коммерческих
    ELSE 0
  END) as materials_cost,

  -- Работы
  SUM(CASE
    WHEN bi.boq_item_type = 'раб'
    THEN bi.initial_price * bi.quantity
    ELSE 0
  END) as works_cost,

  -- Субподрядные материалы
  SUM(CASE
    WHEN bi.boq_item_type = 'суб-мат'
    THEN bi.initial_price * bi.quantity
    ELSE 0
  END) as sub_materials_cost,

  -- ... другие типы

FROM detail_cost_categories dcc
LEFT JOIN cost_categories cc ON dcc.cost_category_id = cc.id
LEFT JOIN boq_items bi ON bi.detail_cost_category_id = dcc.id
LEFT JOIN client_positions cp ON bi.client_position_id = cp.id
WHERE cp.tender_id = $1
GROUP BY dcc.id, dcc.name, cc.name, dcc.location
```

## Пользовательские сценарии

### Просмотр затрат тендера
1. Выбрать тендер из выпадающего списка/карточек
2. По умолчанию показываются прямые затраты
3. Дерево показывает все категории затрат
4. Числа рассчитаны из позиций СМР
5. Объемы загружены из базы данных

### Переключение типа затрат
1. Нажать переключатель "Коммерческие затраты"
2. Таблица пересчитывается с ценами с наценкой
3. Все числа обновляются мгновенно
4. Объем и структура остаются прежними

### Редактирование объемов
1. Найти строку детализации/локации
2. Нажать в колонке Объем
3. Ввести новый объем
4. Нажать Enter или щелкнуть вне поля
5. Объем сохранен в базу данных
6. Затраты автоматически пересчитаны

### Переключение режима просмотра
1. Нажать "Сводка" для сводного вида
2. Или "Детально" для детального вида
3. Таблица перестраивается соответственно
4. Данные остаются те же, меняется представление

### Поиск затрат
1. Ввести в поле поиска
2. Таблица фильтруется в реальном времени
3. Выделяются соответствующие строки
4. Очистить для показа всех

### Скрытие нулевых значений
1. Переключить "Скрыть нулевые"
2. Строки с нулевыми затратами скрыты
3. Структура дерева сохранена
4. Выключить для показа всех

### Экспорт в Excel
1. Убедиться, что тендер выбран
2. Нажать "Экспорт в Excel"
3. Файл генерируется с двумя листами
4. Загрузка начинается автоматически
5. Открыть для просмотра форматированных затрат

## API эндпоинты

### Получение затрат на строительство
```typescript
const { data, error } = await supabase
  .rpc('get_construction_costs', {
    p_tender_id: tenderId,
    p_use_commercial: costType === 'commercial'
  });
```

### Получение объемов
```typescript
const { data: volumes } = await supabase
  .from('construction_cost_volumes')
  .select('*')
  .eq('tender_id', tenderId);
```

### Обновление объема
```typescript
const { error } = await supabase
  .from('construction_cost_volumes')
  .upsert({
    tender_id: tenderId,
    detail_cost_category_id: detailId,
    volume: newVolume,
    updated_at: new Date().toISOString(),
  });
```

## Расчеты

### Расчет общей стоимости
```typescript
function calculateTotalCost(
  materialsCost: number,
  worksCost: number,
  subMaterialsCost: number,
  subWorksCost: number,
  compMaterialsCost: number,
  compWorksCost: number
): number {
  return (
    materialsCost +
    worksCost +
    subMaterialsCost +
    subWorksCost +
    compMaterialsCost +
    compWorksCost
  );
}
```

### Расчет единичной стоимости
```typescript
function calculateUnitCost(totalCost: number, volume: number): number {
  if (volume === 0) return 0;
  return totalCost / volume;
}
```

### Переключение типа затрат
```typescript
// Прямые затраты используют initial_price
const directCost = boqItem.initial_price * boqItem.quantity;

// Коммерческие затраты используют calculated_price (с наценкой)
const commercialCost = boqItem.calculated_price * boqItem.quantity;
```

## Формат экспорта в Excel

### Лист 1: Прямые затраты
```
A1: "Прямые затраты"
A2: [Название тендера]
A3: "Дата: [Дата]"

A5: "Категория"
B5: "Материалы"
C5: "Работы"
D5: "Суб-материалы"
E5: "Суб-работы"
F5: "Мат-компл."
G5: "Раб-компл."
H5: "Итого"
I5: "Объем"
J5: "Ед. стоимость"
K5: "Общая стоимость"

A6: [Категория 1]
...
```

### Лист 2: Коммерческие затраты
Та же структура, что и Лист 1, другие значения.

### Стилизация
- Заголовки: Жирный, цвет заливки, по центру
- Числа: Разделитель тысяч, 2 десятичных знака
- Иерархия: Отступ через объединение
- Границы: Все ячейки
- Итоги: Жирный, верхняя граница

## Таблица сравнения

### Ключевые различия

| Функция | Справочник затрат | Анализ затрат на строительство |
|---------|----------------------|---------------------------|
| **Маршрут** | `/admin/construction_cost` | `/costs` |
| **Назначение** | Управление структурой | Анализ тендера |
| **Тендер** | Не привязан к тендеру | По конкретному тендеру |
| **Объемы** | Не редактируются (нет объемов) | Редактируемые объемы |
| **Расчеты** | Нет расчетов | Полный расчет затрат |
| **Позиции СМР** | Не используются | Агрегируются из СМР |
| **Типы затрат** | Н/Д | Переключение Прямые / Коммерческие |
| **Excel** | Импорт структуры | Экспорт затрат |
| **Основные пользователи** | Администраторы | Все пользователи |
| **CRUD** | Полный CRUD по структуре | Структура только для чтения, редактирование объемов |
| **Когда использовать** | Настройка системы | Анализ затрат проекта |

## Связанные страницы

- **[Позиции позиций](POSITION_ITEMS.md)**: Источник позиций СМР
- **[Коммерция](COMMERCE_PAGE.md)**: Похожие коммерческие расчеты
- **[Финансовые показатели](FINANCIAL_INDICATORS.md)**: Показатели на уровне тендера

## Скриншоты

_Здесь будут размещены скриншоты:_

**Справочник затрат**:
1. Вид структуры дерева
2. Модальное окно импорта из Excel
3. Генерация SQL
4. Модальное окно добавления категории
5. Модальное окно редактирования элемента

**Анализ затрат на строительство**:
1. Выбор тендера
2. Вид прямых затрат
3. Вид коммерческих затрат
4. Редактирование объема
5. Колонки разбивки по типам
6. Образец экспорта в Excel (два листа)

## Технические примечания

### Почему две страницы?

**Разделение задач**:
- **Каталог**: Определение структуры (одноразовая настройка)
- **Анализ**: Анализ данных (частое использование)

**Разные источники данных**:
- **Каталог**: `cost_categories`, `detail_cost_categories`
- **Анализ**: Выше + `boq_items`, `construction_cost_volumes`

**Разные разрешения**:
- **Каталог**: Только администраторы (изменения структуры)
- **Анализ**: Все пользователи (просмотр затрат, редактирование объемов)

### Распределение ценообразования в позициях СМР

Позиции СМР имеют поле `detail_cost_category_id`, которое связывается с категориями затрат. Это позволяет:
- Автоматическую агрегацию по категориям
- Разбивку на основе типов
- Анализ распределения затрат

```typescript
// При добавлении позиции СМР, назначить категорию затрат
const { data } = await supabase
  .from('boq_items')
  .insert({
    detail_cost_category_id: categoryId, // Связь со структурой затрат
    // ... другие поля
  });
```

## Будущие улучшения

### Справочник затрат
- [ ] Улучшения валидации импорта
- [ ] Экспорт структуры в Excel
- [ ] Шаблоны категорий
- [ ] Массовые операции
- [ ] История версий

### Анализ затрат на строительство
- [ ] Сравнение бюджета и фактических затрат
- [ ] Анализ отклонений затрат
- [ ] Исторические тренды затрат
- [ ] Пользовательские группировки затрат
- [ ] Экспорт в PDF с графиками
- [ ] Правила распределения затрат
- [ ] Сравнение нескольких тендеров
