# Документация страницы "Позиции заказчика"

## Обзор

Страница "Позиции заказчика" (`/positions`) - ключевая функция TenderHUB для управления иерархической структурой позиций ведомости объемов работ (BOQ) в строительных тендерах. Она предоставляет комплексный интерфейс для просмотра, редактирования и организации предоставленных заказчиком рабочих позиций с поддержкой дополнительных работ (ДОП).

**Маршрут**: `/positions`
**Компонент**: `src/pages/ClientPositions/ClientPositions.tsx`
**Уровень доступа**: Все авторизованные пользователи

## Возможности

### 1. Выбор тендера
- **Двухэтапный процесс выбора**:
  - Первый: Выбор названия тендера (показывает уникальные названия тендеров)
  - Второй: Выбор версии (показывает все версии для выбранного тендера)
- **Быстрый выбор карточкой**: Сетка последних тендеров для выбора одним кликом
- **Навигация возврата**: Кнопка "Вернуться к выбору" для смены тендеров

### 2. Управление иерархическими позициями
- **Многоуровневая иерархия**: Неограниченная глубина вложенности с отношениями `parent_id`
- **Визуальные отступы**: 20px на уровень иерархии для визуальной ясности
- **Номера разделов**: Автоматическая нумерация разделов для организационной структуры
- **Определение конечных позиций**: Различие между родительскими разделами и конечными позициями

### 3. Система дополнительных работ (ДОП)
- **Создание**: Добавление дополнительных работ из любой обычной позиции через кнопку "+" в колонке "Итого"
- **Десятичная нумерация**: Родительская позиция 5 → дополнительные работы 5.1, 5.2, 5.3
- **Визуальные маркеры**:
  - Оранжевый тег "ДОП" вместо номера раздела
  - Отступ слева 20px для визуального различия
- **Ограничения**:
  - Нельзя создать вложенные дополнительные работы
  - Всегда конечные позиции (могут содержать элементы BOQ)

### 4. Встроенное редактирование
- **Объем вручную (ГП)**: Клик для редактирования поля `manual_volume`
- **Примечание вручную**: Клик для редактирования поля `manual_note`
- **Автосохранение**: Изменения сохраняются при потере фокуса/нажатии Enter

### 5. Функция копирования/вставки
- **Копировать позицию**: Контекстное меню правой кнопкой или горячая клавиша
- **Вставить позицию**: Дублирует позицию со всеми элементами BOQ
- **Визуальная обратная связь**: Скопированная позиция подсвечена в UI

### 6. Поиск и фильтрация
- **Быстрый поиск**: AutoComplete с выпадающими подсказками
- **Минимум 2 символа**: Поиск с задержкой (300мс)
- **Прокрутка к результату**: Автоматическая прокрутка и подсветка при выборе
- **Поля поиска**: Номер позиции и название работы

### 7. Экспорт в Excel
- **Полный экспорт**: Все позиции с сохранением иерархии
- **Форматированный вывод**: Отступы, цвета, границы
- **Включает**: Номера позиций, названия, объемы, единицы измерения

### 8. Отслеживание дедлайнов
- **Визуальная полоса дедлайна**: Показывает дни до крайнего срока тендера
- **Цветовое кодирование**:
  - Красный: < 7 дней осталось
  - Оранжевый: 7-14 дней
  - Зеленый: > 14 дней
- **Отображение обратного отсчета**: "Осталось X дней"

## UI компоненты

### TenderSelectionScreen
**Назначение**: Начальный интерфейс выбора тендера

**Возможности**:
- Выпадающий список названий тендеров
- Селектор версий
- Карточки быстрого выбора (6 последних тендеров)
- Отображение имени клиента

### PositionToolbar
**Назначение**: Основная панель инструментов с информацией о тендере и действиями

**Возможности**:
- Селекторы названия тендера и версии
- Кнопка возврата к выбору
- Градиентный фон (#0f766e → #14b8a6)

### DeadlineBar
**Назначение**: Визуальный индикатор дедлайна

**Возможности**:
- Расчет оставшихся дней
- Цветная полоса прогресса
- Отображение информации о тендере

### PositionTable
**Назначение**: Основная таблица иерархических позиций

**Колонки**:
1. Номер позиции (с индикатором раздела/ДОП)
2. Название работы (кликабельно для конечных позиций)
3. Код единицы измерения (цветной тег)
4. Объем заказчика
5. Объем вручную (ГП) - редактируемый
6. Примечание вручную - редактируемое
7. Колонка "Итого" (с кнопкой + для дополнительных работ)

**Стили строк**:
- Конечные позиции: Кликабельные, курсор pointer
- Родительские позиции: Некликабельные, курсор default
- Дополнительные работы: С отступом, оранжевый тег
- Подсвеченные: Желтый фон при возврате из элементов BOQ

## Пользовательские сценарии

### Создание дополнительной работы
1. Найти родительскую позицию в таблице
2. Нажать кнопку "+" в колонке "Итого"
3. Открывается модальное окно с автогенерированным номером позиции
4. Заполнить название работы и единицу измерения
5. Нажать "Создать" для сохранения
6. Новая позиция появляется с десятичной нумерацией

### Редактирование объемов позиции
1. Кликнуть на ячейку "Объем вручную (ГП)"
2. Появляется поле ввода с текущим значением
3. Ввести новый объем
4. Нажать Enter или кликнуть вне для сохранения
5. Значение мгновенно обновляется в базе данных

### Навигация к элементам BOQ
1. Найти конечную позицию (конец ветви)
2. Кликнуть на название позиции
3. Перенаправление на `/positions/:positionId/items`
4. URL включает идентификаторы тендера и позиции для навигации

### Копирование/вставка позиции
1. Кликнуть правой кнопкой на строке позиции
2. Выбрать "Копировать позицию"
3. ID позиции сохранен в состоянии компонента
4. Перейти к месту вставки
5. Кликнуть правой кнопкой и выбрать "Вставить"
6. Позиция дублируется со всеми элементами BOQ

### Поиск позиций
1. Ввести в поле поиска (мин. 2 символа)
2. Выпадающий список показывает совпадающие позиции
3. Кликнуть на результат для прокрутки и подсветки
4. Подсветка исчезает через 3 секунды

## Модель данных

### Основная таблица: `client_positions`

```sql
CREATE TABLE client_positions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  tender_id UUID REFERENCES tenders(id) ON DELETE CASCADE,
  parent_id UUID REFERENCES client_positions(id) ON DELETE CASCADE,
  position_number NUMERIC(10,2) NOT NULL,
  section_number TEXT,
  work_name TEXT NOT NULL,
  unit_code TEXT,
  volume NUMERIC(15,3),
  manual_volume NUMERIC(15,3),
  manual_note TEXT,
  hierarchy_level INTEGER DEFAULT 0,
  is_additional BOOLEAN DEFAULT false,
  parent_position_id UUID REFERENCES client_positions(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**Ключевые поля**:
- `position_number`: Numeric для поддержки десятичных (5.1, 5.2)
- `parent_id`: Самоссылка для иерархии
- `is_additional`: Флаг для дополнительных работ (ДОП)
- `parent_position_id`: Ссылка на родителя для дополнительных работ
- `hierarchy_level`: Глубина в дереве (0 = корень)

### Связанные таблицы
- `tenders`: Информация о родительском тендере
- `boq_items`: Работы и материалы для каждой позиции
- `units`: Справочник единиц измерения

## API эндпоинты (Supabase)

### Получить позиции
```typescript
const { data, error } = await supabase
  .from('client_positions')
  .select('*')
  .eq('tender_id', tenderId)
  .order('position_number', { ascending: true });
```

### Создать дополнительную работу
```typescript
const { data, error } = await supabase
  .from('client_positions')
  .insert({
    tender_id: tenderId,
    parent_id: parentId,
    parent_position_id: parentId,
    position_number: newPositionNumber,
    work_name: workName,
    unit_code: unitCode,
    is_additional: true,
    hierarchy_level: parentLevel + 1,
  });
```

### Обновить объем вручную
```typescript
const { error } = await supabase
  .from('client_positions')
  .update({
    manual_volume: newVolume,
    updated_at: new Date().toISOString(),
  })
  .eq('id', positionId);
```

### Копировать позицию с элементами
```typescript
// 1. Копировать позицию
const { data: newPosition } = await supabase
  .from('client_positions')
  .insert({ ...position, id: undefined })
  .select()
  .single();

// 2. Копировать элементы BOQ
const { data: items } = await supabase
  .from('boq_items')
  .select('*')
  .eq('client_position_id', originalPositionId);

await supabase
  .from('boq_items')
  .insert(items.map(item => ({
    ...item,
    id: undefined,
    client_position_id: newPosition.id
  })));
```

## Расчеты

### Номер позиции для дополнительных работ
```typescript
// Найти максимальное десятичное число для родителя
const existingAdditional = positions.filter(
  p => p.parent_position_id === parentId && p.is_additional
);

const maxDecimal = existingAdditional.reduce((max, p) => {
  const decimal = parseFloat(p.position_number.toString().split('.')[1] || '0');
  return Math.max(max, decimal);
}, 0);

const newPositionNumber = parseFloat(
  `${parentPositionNumber}.${maxDecimal + 1}`
);
```

### Расчет уровня иерархии
```typescript
function calculateHierarchyLevel(positions: Position[], position: Position): number {
  let level = 0;
  let current = position;

  while (current.parent_id) {
    level++;
    current = positions.find(p => p.id === current.parent_id);
    if (!current) break;
  }

  return level;
}
```

### Определение конечной позиции
```typescript
function isLeafPosition(index: number, positions: Position[]): boolean {
  if (index === positions.length - 1) return true;

  const currentLevel = positions[index].hierarchy_level || 0;
  const nextLevel = positions[index + 1]?.hierarchy_level || 0;

  return currentLevel >= nextLevel;
}
```

## Управление состоянием

### URL параметры
- `tenderId`: ID выбранного тендера (восстанавливается при возврате навигации)
- `positionId`: Позиция для прокрутки и подсветки

### Состояние компонента
```typescript
interface ClientPositionsState {
  selectedTenderId: string | null;
  selectedTenderTitle: string | null;
  selectedVersion: number | null;
  scrollToPositionId: string | null;
  additionalModalOpen: boolean;
  selectedParentId: string | null;
  searchValue: string;
  searchOptions: AutoCompleteOption[];
  copiedPositionId: string | null;
}
```

## Формат экспорта в Excel

### Структура колонок
1. Номер позиции
2. Номер раздела / тег ДОП
3. Название работы (с отступами)
4. Код единицы измерения
5. Объем заказчика
6. Объем вручную (ГП)
7. Примечание вручную

### Стилизация
- **Заголовки**: Жирный, центрированный, фоновый цвет
- **Иерархия**: Отступы через объединение ячеек и заполнение
- **Дополнительные работы**: Оранжевый фоновый цвет
- **Границы**: Все ячейки с границами
- **Формат чисел**: 0.00 для объемов

## Оптимизация производительности

### Поиск с задержкой
- Задержка 300мс перед фильтрацией
- Ограничение результатов до 50 совпадений
- Ранний выход при пустом поиске

### Виртуализация прокрутки
- Таблица использует виртуальную прокрутку Ant Design
- Отображаются только видимые строки
- Плавная прокрутка к подсвеченным элементам

### Мемоизированные вычисления
- Количество позиций кешируется для каждого тендера
- Определение конечных позиций мемоизировано
- Уровни иерархии предвычислены

## Обработка ошибок

### Сетевые ошибки
- Toast-уведомления для неудачных операций
- Механизм повторных попыток для временных сбоев
- Состояния загрузки во время асинхронных операций

### Ошибки валидации
- Проверка обязательных полей перед сохранением
- Валидация формата чисел для объемов
- Принудительная уникальность номеров позиций

## Связанные страницы

- **[Элементы позиций](POSITION_ITEMS.md)**: Элементы BOQ для каждой позиции
- **[Коммерция](COMMERCE_PAGE.md)**: Коммерческие расчеты с использованием данных позиций
- **[Дашборд](DASHBOARD_DESIGN_SYSTEM.md)**: Обзор и статистика тендеров

## Скриншоты

_Скриншоты будут размещены здесь, показывающие:_
1. Экран выбора тендера
2. Иерархическая таблица позиций
3. Модальное окно создания дополнительной работы
4. Встроенное редактирование в действии
5. Контекстное меню копирования/вставки
6. Функция поиска и подсветки
7. Пример экспорта в Excel

## Технические заметки

### Паттерн навигации возврата
```typescript
// При переходе к элементам BOQ
navigate(`/positions/${record.id}/items?tenderId=${tenderId}&positionId=${positionId}`);

// При возврате
const tenderId = searchParams.get('tenderId');
const positionId = searchParams.get('positionId');
navigate(`/positions?tenderId=${tenderId}&positionId=${positionId}`);
```

### Прокрутка и подсветка
```typescript
useEffect(() => {
  if (scrollToPositionId && clientPositions.length > 0 && !loading) {
    setTimeout(() => {
      const element = document.querySelector(`[data-row-key="${scrollToPositionId}"]`);
      element?.scrollIntoView({ behavior: 'smooth', block: 'center' });

      setTimeout(() => {
        setScrollToPositionId(null);
        setSearchParams({});
      }, 2000);
    }, 500);
  }
}, [scrollToPositionId, clientPositions, loading]);
```

### Ограничения дополнительных работ
```typescript
// Кнопка отключена для дополнительных работ
{!record.is_additional && (
  <Button
    size="small"
    icon={<PlusOutlined />}
    onClick={(e) => handleOpenAdditionalModal(record.id, e)}
  >
    ДОП
  </Button>
)}
```

## Будущие улучшения

- [ ] Массовые операции (перемещение, удаление нескольких позиций)
- [ ] Шаблоны позиций для общих структур
- [ ] Импорт позиций из Excel
- [ ] История и версионирование позиций
- [ ] Изменение порядка drag-and-drop
- [ ] Расширенная фильтрация (по единице, диапазону объемов)
- [ ] Примечания и вложения к позициям
