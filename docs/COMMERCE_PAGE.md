# Страница "Коммерция"

## Обзор

Страница "Коммерция" предназначена для отображения и управления коммерческими стоимостями позиций заказчика. Она позволяет просматривать позиции с рассчитанными коммерческими стоимостями, выполнять пересчет и экспортировать данные.

## Функциональность

### Основные возможности:
1. **Выбор тендера** - выпадающий список для выбора нужного тендера
2. **Просмотр позиций** - таблица позиций заказчика с коммерческими стоимостями
3. **Пересчет стоимостей** - применение тактики наценок ко всему тендеру
4. **Экспорт в Excel** - выгрузка данных в формате Excel
5. **Статистика** - отображение итоговых сумм и средней наценки

## Расчет коммерческих стоимостей

### Принцип расчета:
```
Коммерческая стоимость позиции =
  Σ(total_commercial_material_cost всех boq_items) +
  Σ(total_commercial_work_cost всех boq_items)
```

Где boq_items - это элементы, привязанные к позиции заказчика через `client_position_id`.

### Процесс пересчета:
1. При нажатии кнопки "Пересчитать" вызывается функция `applyTacticToTender()`
2. Система применяет тактику наценок ко всем элементам BOQ в тендере
3. Для каждого элемента:
   - Берется базовая стоимость из `total_amount`
   - Применяется соответствующая последовательность операций для типа элемента
   - Результат сохраняется в `total_commercial_material_cost` или `total_commercial_work_cost`
4. Страница автоматически обновляется с новыми данными

## Компоненты интерфейса

### Заголовок страницы
- Название "Коммерция" с иконкой
- Выбор тендера
- Кнопки действий:
  - **Пересчитать** - запускает пересчет коммерческих стоимостей
  - **Экспорт** - выгружает данные в Excel
  - **Обновить** - перезагружает данные

### Информационная панель тендера
Отображает:
- Название клиента
- Номер тендера
- Версию

### Статистические карточки
Четыре карточки с ключевыми метриками:
1. **Базовая стоимость** - сумма базовых стоимостей всех позиций
2. **Коммерческая стоимость** - сумма коммерческих стоимостей
3. **Разница** - абсолютная разница между коммерческой и базовой стоимостями
4. **Средняя наценка** - процентная наценка

### Таблица позиций

| Колонка | Описание | Источник данных |
|---------|----------|-----------------|
| № позиции | Номер позиции заказчика | `position_number` |
| Название | Название работы/позиции | `work_name` |
| Примечание | Примечание клиента | `client_note` |
| Кол-во | Объем работ и количество элементов | `volume`, `unit_code`, подсчет `boq_items` |
| Базовая стоимость | Сумма базовых стоимостей элементов | Σ(`total_amount` из `boq_items`) |
| Коммерческая стоимость | Сумма коммерческих стоимостей | Σ(`total_commercial_*` из `boq_items`) |
| Наценка | Процент наценки | Расчетное поле |
| За единицу | Стоимость за единицу | Коммерческая стоимость / объем |

### Итоговая строка
Отображается внизу каждой страницы таблицы с суммами по текущей странице.

## Экспорт в Excel

### Формат экспорта:
- Файл: `Коммерция_[номер_тендера]_[дата].xlsx`
- Лист: "Коммерческие стоимости"
- Включает все позиции с данными
- Добавляется итоговая строка с суммами

### Колонки в Excel:
1. Номер позиции
2. Название
3. Примечание клиента
4. Единица
5. Количество
6. Кол-во элементов
7. Базовая стоимость
8. Коммерческая стоимость
9. Наценка, %
10. За единицу (база)
11. За единицу (коммерч.)

## Технические детали

### Используемые компоненты:
- **Ant Design**: Table, Select, Button, Card, Statistic, Spin, Empty, Tag
- **XLSX**: для экспорта в Excel
- **Supabase**: для работы с базой данных

### Ключевые функции:
```typescript
// Загрузка позиций с коммерческими стоимостями
loadPositions(tenderId: string)

// Пересчет коммерческих стоимостей
handleRecalculate()

// Экспорт данных
handleExportToExcel()
```

### Оптимизация производительности:
1. Параллельная загрузка данных с помощью `Promise.all()`
2. Мемоизация итоговых сумм с `useMemo`
3. Пагинация таблицы для больших объемов данных

## Интеграция с системой наценок

Страница использует сервис `markupTacticService` для:
- Применения тактик наценок к элементам тендера
- Автоматического пересчета при изменении параметров
- Обновления итоговых сумм в позициях

## Права доступа

На данный момент страница доступна всем авторизованным пользователям. В будущем планируется добавить ролевую модель:
- **Просмотр**: все роли
- **Пересчет**: engineer, manager, administrator
- **Экспорт**: manager, director, administrator

## Дальнейшее развитие

### Планируемые улучшения:
1. **Детализация позиций** - возможность просмотра элементов BOQ внутри позиции
2. **Сравнение версий** - отображение изменений между версиями
3. **Графики и визуализация** - диаграммы распределения наценок
4. **Фильтры и поиск** - расширенная фильтрация по различным параметрам
5. **История изменений** - логирование всех пересчетов
6. **Массовое редактирование** - возможность изменения коэффициентов для группы позиций